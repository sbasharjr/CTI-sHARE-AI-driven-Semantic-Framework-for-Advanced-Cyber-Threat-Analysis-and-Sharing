<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI-sHARE Threat Intelligence Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255,255,255,0.95); 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: rgba(255,255,255,0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .stat-number { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 10px;
        }
        .stat-label { font-size: 1.1em; color: #666; }
        .card { 
            background: rgba(255,255,255,0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 25px; 
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .threat-item { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .threat-high { border-left-color: #dc3545; }
        .threat-medium { border-left-color: #ffc107; }
        .threat-low { border-left-color: #28a745; }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px 4px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        button.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        button.danger { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
        button.warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: #000; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .operation-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .analysis-result {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-family: inherit;
            resize: vertical;
        }
        textarea:focus { border-color: #667eea; outline: none; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 16px;
        }
        input[type="text"]:focus { border-color: #667eea; outline: none; }
        .realtime-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .realtime-active { background: #28a745; color: white; }
        .realtime-inactive { background: #dc3545; color: white; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è CTI-sHARE Threat Intelligence Dashboard</h1>
            <p>AI-driven Semantic Framework for Advanced Cyber Threat Analysis and Sharing</p>
            <p><span class="status-indicator"></span>System Online | <span id="realtimeStatusHeader" class="realtime-status realtime-inactive">Real-time: Inactive</span></p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalThreats">0</div>
                <div class="stat-label">Total Threats</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highSeverity">0</div>
                <div class="stat-label">High Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="detectionRate">0%</div>
                <div class="stat-label">Detection Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="systemStatus">Active</div>
                <div class="stat-label">System Status</div>
            </div>
        </div>

        <div class="card">
            <h2>ü§ñ AI Operations Center</h2>
            <div class="grid-3">
                <div style="text-align: center;">
                    <h3>üöÄ Model Training</h3>
                    <p>Train ML models with latest threat data</p>
                    <button onclick="trainModels()" id="trainBtn">Train Models</button>
                </div>
                <div style="text-align: center;">
                    <h3>‚ö° Real-time Detection</h3>
                    <p>Monitor threats in real-time</p>
                    <button onclick="toggleRealtime()" id="realtimeBtn">Start Real-time</button>
                </div>
                <div style="text-align: center;">
                    <h3>üîç Text Analysis</h3>
                    <p>Analyze text for threat indicators</p>
                    <button onclick="showAnalyzer()" id="analyzeBtn">Analyze Text</button>
                </div>
            </div>
            
            <div id="operationStatus" class="operation-status" style="display: none;">
                <div id="statusMessage">Ready for operations...</div>
                <div class="progress-bar">
                    <div id="progress" class="progress" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="card" id="analyzerCard" style="display: none;">
            <h2>üîç Threat Analysis</h2>
            <textarea id="analyzeText" placeholder="Enter text to analyze for threats (e.g., 'Suspicious email with malware attachment detected', 'DDoS attack on network infrastructure', etc.)" rows="4"></textarea>
            <button onclick="analyzeText()" id="analyzeSubmitBtn">Analyze Threat Text</button>
            <div id="analysisResult" class="analysis-result" style="display: none;"></div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>üìä Recent Threat Activity</h2>
                <div id="recentThreats">
                    <div class="threat-item">
                        <strong>Loading threat data...</strong>
                    </div>
                </div>
                <button onclick="loadRecentThreats()">Refresh Data</button>
            </div>

            <div class="card">
                <h2>üìà Threat Categories</h2>
                <div id="categoriesChart" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 150px;">
                    Loading category distribution...
                </div>
                <button onclick="loadCategories()">Update Chart</button>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>‚ö†Ô∏è Severity Distribution</h2>
                <div id="severityChart" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 150px;">
                    Loading severity data...
                </div>
            </div>

            <div class="card">
                <h2>‚ö° Real-time Statistics</h2>
                <div id="realtimeStats" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 150px;">
                    <div>Real-time detection status: <span id="realtimeStatus">Inactive</span></div>
                    <div>Threats processed: <span id="threatsProcessed">0</span></div>
                    <div>Detection rate: <span id="realtimeDetectionRate">0%</span></div>
                </div>
                <button onclick="updateRealtimeStats()">Refresh Stats</button>
            </div>
        </div>

        <div class="card">
            <h2>‚ûï Submit New Threat</h2>
            <input type="text" id="threatText" placeholder="Enter threat description...">
            <button onclick="submitThreat()">Submit Threat</button>
        </div>
    </div>

    <script>
        // Dashboard JavaScript functionality
        let refreshInterval;
        let isRealtimeActive = false;

        function showOperationStatus(message, progress = 0) {
            const statusDiv = document.getElementById('operationStatus');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progress');
            
            statusMessage.textContent = message;
            progressBar.style.width = progress + '%';
            statusDiv.style.display = 'block';
            
            if (progress >= 100) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        function trainModels() {
            const trainBtn = document.getElementById('trainBtn');
            trainBtn.disabled = true;
            trainBtn.textContent = 'Training...';
            
            showOperationStatus('Starting model training...', 10);
            
            fetch('/api/dashboard/train', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                showOperationStatus('Training completed!', 100);
                
                if (data.status === 'success') {
                    trainBtn.className = 'success';
                    trainBtn.textContent = '‚úÖ Training Complete';
                    alert(`Training successful!\\nAccuracy: ${(data.metrics?.train_accuracy * 100 || 0).toFixed(1)}%`);
                } else {
                    trainBtn.className = 'danger';
                    trainBtn.textContent = '‚ùå Training Failed';
                    alert('Training failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Training error:', error);
                showOperationStatus('Training failed!', 100);
                trainBtn.className = 'danger';
                trainBtn.textContent = '‚ùå Training Failed';
            })
            .finally(() => {
                setTimeout(() => {
                    trainBtn.disabled = false;
                    trainBtn.className = '';
                    trainBtn.textContent = 'üöÄ Train Models';
                }, 3000);
            });
        }

        function toggleRealtime() {
            const realtimeBtn = document.getElementById('realtimeBtn');
            const endpoint = isRealtimeActive ? '/api/dashboard/realtime/stop' : '/api/dashboard/realtime/start';
            
            realtimeBtn.disabled = true;
            
            showOperationStatus(isRealtimeActive ? 'Stopping real-time detection...' : 'Starting real-time detection...', 50);
            
            fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                showOperationStatus(data.message, 100);
                
                if (data.status === 'success') {
                    isRealtimeActive = data.is_running;
                    updateRealtimeUI();
                } else {
                    alert(data.message || 'Operation failed');
                }
            })
            .catch(error => {
                console.error('Real-time operation error:', error);
                showOperationStatus('Operation failed!', 100);
            })
            .finally(() => {
                realtimeBtn.disabled = false;
            });
        }

        function updateRealtimeUI() {
            const realtimeBtn = document.getElementById('realtimeBtn');
            const headerStatus = document.getElementById('realtimeStatusHeader');
            
            if (isRealtimeActive) {
                realtimeBtn.textContent = '‚èπÔ∏è Stop Real-time';
                realtimeBtn.className = 'danger';
                headerStatus.textContent = 'Real-time: Active';
                headerStatus.className = 'realtime-status realtime-active';
            } else {
                realtimeBtn.textContent = '‚ñ∂Ô∏è Start Real-time';
                realtimeBtn.className = 'success';
                headerStatus.textContent = 'Real-time: Inactive';
                headerStatus.className = 'realtime-status realtime-inactive';
            }
        }

        function showAnalyzer() {
            const analyzerCard = document.getElementById('analyzerCard');
            analyzerCard.style.display = analyzerCard.style.display === 'none' ? 'block' : 'none';
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.textContent = analyzerCard.style.display === 'none' ? 'üîç Analyze Text' : '‚ùå Close Analyzer';
        }

        function analyzeText() {
            const text = document.getElementById('analyzeText').value;
            const submitBtn = document.getElementById('analyzeSubmitBtn');
            const resultDiv = document.getElementById('analysisResult');
            
            if (!text.trim()) {
                alert('Please enter text to analyze');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing...';
            
            fetch('/api/dashboard/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const analysis = data.analysis;
                    const topCategory = analysis.top_category;
                    const severity = analysis.severity;
                    
                    resultDiv.innerHTML = `
                        <h3>üìä Analysis Results</h3>
                        <p><strong>Top Category:</strong> ${topCategory[0]} (${(topCategory[1] * 100).toFixed(1)}% confidence)</p>
                        <p><strong>Severity:</strong> ${severity.severity} (${(severity.confidence * 100).toFixed(1)}% confidence)</p>
                        <p><strong>Categories Found:</strong></p>
                        <ul>${Object.entries(analysis.categories).map(([cat, score]) => 
                            `<li>${cat}: ${(score * 100).toFixed(1)}%</li>`).join('')}</ul>
                        <p><strong>Timestamp:</strong> ${analysis.timestamp}</p>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Refresh recent threats to show the new analysis
                    loadRecentThreats();
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">Analysis failed: ${data.message}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                resultDiv.innerHTML = '<p style="color: #dc3545;">Analysis failed due to network error</p>';
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze Threat Text';
            });
        }

        function updateRealtimeStats() {
            fetch('/api/dashboard/realtime/status')
                .then(response => response.json())
                .then(data => {
                    const statusSpan = document.getElementById('realtimeStatus');
                    const processedSpan = document.getElementById('threatsProcessed');
                    const rateSpan = document.getElementById('realtimeDetectionRate');
                    
                    statusSpan.textContent = data.is_running ? 'Active' : 'Inactive';
                    statusSpan.style.color = data.is_running ? '#28a745' : '#dc3545';
                    
                    const stats = data.statistics || {};
                    processedSpan.textContent = stats.total_processed || 0;
                    rateSpan.textContent = ((stats.detection_rate || 0) * 100).toFixed(1) + '%';
                    
                    isRealtimeActive = data.is_running;
                    updateRealtimeUI();
                })
                .catch(error => {
                    console.error('Error loading real-time stats:', error);
                });
        }

        function loadDashboardStats() {
            fetch('/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalThreats').textContent = data.total_threats || 0;
                    document.getElementById('highSeverity').textContent = data.critical_threats || 0;
                    document.getElementById('detectionRate').textContent = (data.detection_rate || 0) + '%';
                    document.getElementById('systemStatus').textContent = 'Active';
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    document.getElementById('totalThreats').textContent = 'Error';
                });
        }

        function loadRecentThreats() {
            fetch('/api/dashboard/threats/recent?limit=5')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentThreats');
                    
                    if (data.threats && data.threats.length > 0) {
                        container.innerHTML = data.threats.map(threat => {
                            const severityClass = threat.severity ? `threat-${threat.severity.toLowerCase()}` : 'threat-low';
                            return `
                                <div class="threat-item ${severityClass}">
                                    <strong>${threat.category || 'Unknown'}</strong><br>
                                    ${threat.description || 'No description available'}<br>
                                    <small>Severity: ${threat.severity || 'Unknown'} | ${threat.timestamp || ''}</small>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="threat-item">No recent threats detected.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading threats:', error);
                    document.getElementById('recentThreats').innerHTML = 
                        '<div class="threat-item">Error loading threat data.</div>';
                });
        }

        function loadCategories() {
            fetch('/api/dashboard/threats/categories')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('categoriesChart');
                    
                    if (data.categories && Object.keys(data.categories).length > 0) {
                        const total = Object.values(data.categories).reduce((a, b) => a + b, 0);
                        container.innerHTML = Object.entries(data.categories).map(([category, count]) => {
                            const percentage = ((count / total) * 100).toFixed(1);
                            return `<div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;">
                                <strong>${category}:</strong> ${count} threats (${percentage}%)
                            </div>`;
                        }).join('');
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #666;">No category data available</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    document.getElementById('categoriesChart').innerHTML = 
                        '<div style="text-align: center; color: #dc3545;">Error loading data</div>';
                });
        }

        function submitThreat() {
            // This would integrate with the existing threat submission system
            const threatText = document.getElementById('threatText').value;
            if (!threatText.trim()) {
                alert('Please enter a threat description');
                return;
            }
            
            // For now, just analyze the text as a threat
            document.getElementById('analyzeText').value = threatText;
            showAnalyzer();
            analyzeText();
            
            document.getElementById('threatText').value = '';
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadDashboardStats();
                loadRecentThreats();
                updateRealtimeStats();
            }, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadRecentThreats();
            loadCategories();
            updateRealtimeStats();
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>