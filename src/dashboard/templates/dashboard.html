<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI-sHARE Threat Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255,255,255,0.95); 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: rgba(255,255,255,0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .stat-number { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 10px;
        }
        .stat-label { font-size: 1.1em; color: #666; }
        .card { 
            background: rgba(255,255,255,0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 25px; 
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .threat-item { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .threat-high { border-left-color: #dc3545; }
        .threat-medium { border-left-color: #ffc107; }
        .threat-low { border-left-color: #28a745; }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px 4px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        button.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        button.danger { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
        button.warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: #000; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .operation-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .analysis-result {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-family: inherit;
            resize: vertical;
        }
        textarea:focus { border-color: #667eea; outline: none; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 16px;
        }
        input[type="text"]:focus { border-color: #667eea; outline: none; }
        .realtime-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .realtime-active { background: #28a745; color: white; }
        .realtime-inactive { background: #dc3545; color: white; }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 20px 0;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        .chart-controls button {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        .metric-trend {
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }
        .trend-up { background: #28a745; }
        .trend-down { background: #dc3545; }
        .trend-stable { background: #6c757d; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .chart-container { height: 300px; }
            .chart-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è CTI-sHARE Threat Intelligence Dashboard</h1>
            <p>AI-driven Semantic Framework for Advanced Cyber Threat Analysis and Sharing</p>
            <p><span class="status-indicator"></span>System Online | <span id="realtimeStatusHeader" class="realtime-status realtime-inactive">Real-time: Inactive</span></p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalThreats">0</div>
                <div class="stat-label">Total Threats</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highSeverity">0</div>
                <div class="stat-label">High Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="detectionRate">0%</div>
                <div class="stat-label">Detection Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="systemStatus">Active</div>
                <div class="stat-label">System Status</div>
            </div>
        </div>

        <div class="card">
            <h2>ü§ñ AI Operations Center</h2>
            <div class="grid-3">
                <div style="text-align: center;">
                    <h3>üöÄ Model Training</h3>
                    <p>Train ML models with latest threat data</p>
                    <button onclick="trainModels()" id="trainBtn">Train Models</button>
                </div>
                <div style="text-align: center;">
                    <h3>‚ö° Real-time Detection</h3>
                    <p>Monitor threats in real-time</p>
                    <button onclick="toggleRealtime()" id="realtimeBtn">Start Real-time</button>
                </div>
                <div style="text-align: center;">
                    <h3>üîç Text Analysis</h3>
                    <p>Analyze text for threat indicators</p>
                    <button onclick="showAnalyzer()" id="analyzeBtn">Analyze Text</button>
                    <button onclick="showBulkAnalyzer()" id="bulkBtn">Bulk Analysis</button>
                </div>
            </div>
            
            <div id="operationStatus" class="operation-status" style="display: none;">
                <div id="statusMessage">Ready for operations...</div>
                <div class="progress-bar">
                    <div id="progress" class="progress" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="card" id="analyzerCard" style="display: none;">
            <h2>üîç Threat Analysis</h2>
            <textarea id="analyzeText" placeholder="Enter text to analyze for threats (e.g., 'Suspicious email with malware attachment detected', 'DDoS attack on network infrastructure', etc.)" rows="4"></textarea>
            <div style="margin: 10px 0;">
                <button onclick="analyzeText()" id="analyzeSubmitBtn">Analyze Threat Text</button>
                <button onclick="extractEntities()" id="entitiesBtn">Extract Entities</button>
            </div>
            <div id="analysisResult" class="analysis-result" style="display: none;"></div>
            <div id="entitiesResult" class="analysis-result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>üåê Threat Intelligence Sharing</h2>
            <div class="grid-3">
                <div style="text-align: center;">
                    <h3>üì§ Upload Intelligence</h3>
                    <p>Upload threat data from files</p>
                    <input type="file" id="fileUpload" accept=".json,.csv,.txt" style="margin: 10px 0; padding: 8px;">
                    <button onclick="uploadIntelligence()" id="uploadBtn">Upload File</button>
                </div>
                <div style="text-align: center;">
                    <h3>üì• Import from Sources</h3>
                    <p>Import from MISP, STIX, TAXII</p>
                    <select id="importSource" style="margin: 10px 0; padding: 8px; border-radius: 4px;">
                        <option value="manual">Manual</option>
                        <option value="misp">MISP</option>
                        <option value="stix">STIX</option>
                        <option value="taxii">TAXII</option>
                    </select>
                    <button onclick="showImportDialog()" id="importBtn">Import Data</button>
                </div>
                <div style="text-align: center;">
                    <h3>üì§ Export & Share</h3>
                    <p>Export and share threat data</p>
                    <select id="exportFormat" style="margin: 10px 0; padding: 8px; border-radius: 4px;">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="stix">STIX</option>
                    </select>
                    <button onclick="exportIntelligence()" id="exportBtn">Export Data</button>
                </div>
            </div>
            
            <div id="intelligenceStatus" class="operation-status" style="display: none;">
                <div id="intelligenceMessage">Processing...</div>
                <div class="progress-bar">
                    <div id="intelligenceProgress" class="progress" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="card" id="importDialog" style="display: none;">
            <h2>üì• Import Threat Intelligence</h2>
            <div style="margin-bottom: 15px;">
                <label><strong>Import Source:</strong></label>
                <select id="importSourceSelect" style="width: 100%; padding: 10px; margin: 5px 0;">
                    <option value="manual">Manual Entry</option>
                    <option value="misp">MISP Format</option>
                    <option value="stix">STIX Format</option>
                    <option value="taxii">TAXII Feed</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label><strong>Data to Import:</strong></label>
                <textarea id="importData" placeholder="Paste JSON data or enter threat descriptions (one per line)..." rows="6" style="width: 100%; padding: 10px; margin: 5px 0;"></textarea>
            </div>
            <div>
                <button onclick="importIntelligence()" id="importSubmitBtn">Import Data</button>
                <button onclick="hideImportDialog()" style="background: #6c757d;">Cancel</button>
            </div>
            <div id="importResult" class="analysis-result" style="display: none;"></div>
        </div>

        <div class="card" id="bulkAnalyzer" style="display: none;">
            <h2>üîç Bulk Semantic Analysis</h2>
            <textarea id="bulkAnalyzeText" placeholder="Enter multiple threat texts (one per line) for bulk analysis..." rows="6" style="width: 100%; padding: 10px; margin: 10px 0;"></textarea>
            <button onclick="analyzeBulk()" id="bulkAnalyzeBtn">Analyze All Texts</button>
            <div id="bulkAnalysisResult" class="analysis-result" style="display: none;"></div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>üìä Recent Threat Activity</h2>
                <div id="recentThreats">
                    <div class="threat-item">
                        <strong>Loading threat data...</strong>
                    </div>
                </div>
                <button onclick="loadRecentThreats()">Refresh Data</button>
            </div>

            <div class="card">
                <div class="chart-header">
                    <h2>üìà Threat Categories</h2>
                    <div class="chart-controls">
                        <button onclick="loadCategories()">Update Chart</button>
                        <button onclick="exportChart('categories')">Export</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Severity Distribution with Real-time Updates -->
        <div class="card">
            <div class="chart-header">
                <h2>‚ö†Ô∏è Active Severity Distribution</h2>
                <div class="chart-controls">
                    <button onclick="toggleSeverityRealtime()" id="severityRealtimeBtn">Start Real-time</button>
                    <button onclick="resetSeverityChart()">Reset</button>
                    <button onclick="exportChart('severity')">Export</button>
                </div>
            </div>
            
            <!-- Real-time Metrics -->
            <div class="grid-3" style="margin-bottom: 20px;">
                <div class="metric-card">
                    <div>
                        <div class="stat-label">Critical Rate</div>
                        <div class="metric-value" id="criticalRate">0%</div>
                    </div>
                    <div class="metric-trend trend-up" id="criticalTrend">+2.3%</div>
                </div>
                <div class="metric-card">
                    <div>
                        <div class="stat-label">Threat Velocity</div>
                        <div class="metric-value" id="threatVelocity">0/min</div>
                    </div>
                    <div class="metric-trend trend-stable" id="velocityTrend">stable</div>
                </div>
                <div class="metric-card">
                    <div>
                        <div class="stat-label">Detection Accuracy</div>
                        <div class="metric-value" id="detectionAccuracy">0%</div>
                    </div>
                    <div class="metric-trend trend-up" id="accuracyTrend">+0.5%</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <h3>Severity Distribution</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3>24-Hour Trend</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="severityTimeSeriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Real-time Statistics Dashboard -->
        <div class="card">
            <div class="chart-header">
                <h2>‚ö° Real-time Statistics & System Performance</h2>
                <div class="chart-controls">
                    <button onclick="toggleAdvancedRealtime()" id="advancedRealtimeBtn">Start Monitoring</button>
                    <button onclick="refreshAdvancedStats()">Refresh</button>
                    <button onclick="exportChart('realtime')">Export</button>
                </div>
            </div>
            
            <!-- System Performance Metrics -->
            <div class="grid-3" style="margin-bottom: 20px;">
                <div class="metric-card">
                    <div>
                        <div class="stat-label">Active Incidents</div>
                        <div class="metric-value" id="activeIncidents">0</div>
                    </div>
                    <div class="metric-trend trend-down" id="incidentsTrend">-15%</div>
                </div>
                <div class="metric-card">
                    <div>
                        <div class="stat-label">Blocked Attacks</div>
                        <div class="metric-value" id="blockedAttacks">0</div>
                    </div>
                    <div class="metric-trend trend-up" id="blockedTrend">+28%</div>
                </div>
                <div class="metric-card">
                    <div>
                        <div class="stat-label">System CPU</div>
                        <div class="metric-value" id="systemCPU">0%</div>
                    </div>
                    <div class="metric-trend trend-stable" id="cpuTrend">normal</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <div class="chart-header">
                        <h3>üéØ Attack Vectors (Live)</h3>
                        <div class="chart-controls">
                            <button onclick="startAttackVectorsLiveMode()" id="attackVectorsLiveBtn">Start Live Mode</button>
                            <button onclick="exportChart('attack_vectors')">Export</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="attackVectorsChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="chart-header">
                        <h3>üåç Geographic Distribution (Live)</h3>
                        <div class="chart-controls">
                            <button onclick="startGeographicLiveMode()" id="geographicLiveBtn">Start Live Mode</button>
                            <button onclick="exportChart('geographic')">Export</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="geoDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="chart-header">
                    <h3>‚è∞ Hourly Activity Pattern (Live)</h3>
                    <div class="chart-controls">
                        <button onclick="startHourlyActivityLiveMode()" id="hourlyActivityLiveBtn">Start Live Mode</button>
                        <button onclick="exportChart('hourly')">Export</button>
                        <button onclick="resetAllCharts()">Reset All</button>
                        <button onclick="pauseAllLiveModes()">Pause All</button>
                        <button onclick="startAllLiveModes()">Start All</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="hourlyActivityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>üìä System Health Monitor</h2>
                <div id="systemHealthContainer">
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">Memory Usage</div>
                            <div class="metric-value" id="memoryUsage">0%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">Network Throughput</div>
                            <div class="metric-value" id="networkThroughput">0 MB/s</div>
                        </div>
                        <div class="metric-trend trend-up" id="networkTrend">optimal</div>
                    </div>
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">Active Connections</div>
                            <div class="metric-value" id="activeConnections">0</div>
                        </div>
                        <div class="metric-trend trend-stable" id="connectionsTrend">stable</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üéØ Threat Intelligence Feeds</h2>
                <div id="intelligenceFeedsContainer">
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">IOC Feeds Active</div>
                            <div class="metric-value" id="iocFeeds">0</div>
                        </div>
                        <div class="metric-trend trend-up" id="iocTrend">+5 new</div>
                    </div>
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">Feed Health</div>
                            <div class="metric-value" id="feedHealth">0%</div>
                        </div>
                        <div class="metric-trend trend-up" id="healthTrend">excellent</div>
                    </div>
                    <div class="metric-card">
                        <div>
                            <div class="stat-label">Data Freshness</div>
                            <div class="metric-value" id="dataFreshness">0 min</div>
                        </div>
                        <div class="metric-trend trend-up" id="freshnessTrend">up to date</div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div class="card">
            <h2>‚ûï Submit New Threat</h2>
            <input type="text" id="threatText" placeholder="Enter threat description...">
            <button onclick="submitThreat()">Submit Threat</button>
        </div>
    </div>

    <script>
        // Dashboard JavaScript functionality
        let refreshInterval;
        let isRealtimeActive = false;
        
        // Chart instances
        let categoriesChart, severityChart, severityTimeSeriesChart, attackVectorsChart, geoDistributionChart, hourlyActivityChart;
        let severityRealtimeInterval, advancedRealtimeInterval;
        let isSeverityRealtimeActive = false;
        let isAdvancedRealtimeActive = false;

        // Initialize all charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadInitialData();
        });

        function initializeCharts() {
            // Categories Chart (Doughnut)
            const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
            categoriesChart = new Chart(categoriesCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Threat Categories Distribution' }
                    }
                }
            });

            // Severity Distribution Chart (Polar Area)
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            severityChart = new Chart(severityCtx, {
                type: 'polarArea',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Severity Time Series Chart (Line)
            const severityTimeSeriesCtx = document.getElementById('severityTimeSeriesChart').getContext('2d');
            severityTimeSeriesChart = new Chart(severityTimeSeriesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Critical',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'High',
                            data: [],
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Medium',
                            data: [],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });

            // Attack Vectors Chart (Bar) - Enhanced with interactivity
            const attackVectorsCtx = document.getElementById('attackVectorsChart').getContext('2d');
            attackVectorsChart = new Chart(attackVectorsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Threat Count',
                        data: [],
                        backgroundColor: function(context) {
                            const severity = context.parsed.y;
                            if (severity > 120) return '#dc3545';  // Critical
                            if (severity > 90) return '#fd7e14';   // High
                            if (severity > 60) return '#ffc107';   // Medium
                            return '#28a745';  // Low
                        },
                        borderColor: '#667eea',
                        borderWidth: 1,
                        hoverBackgroundColor: function(context) {
                            const severity = context.parsed.y;
                            if (severity > 120) return '#c82333';  // Darker critical
                            if (severity > 90) return '#e8630e';   // Darker high
                            if (severity > 60) return '#e0a800';   // Darker medium
                            return '#1e7e34';  // Darker low
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Attack Vector: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    let severity = 'Low';
                                    if (value > 120) severity = 'Critical';
                                    else if (value > 90) severity = 'High';
                                    else if (value > 60) severity = 'Medium';
                                    return `Threats: ${value} (${severity} Risk)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Threat Count'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutBounce'
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const label = this.data.labels[index];
                            const value = this.data.datasets[0].data[index];
                            console.log(`Attack Vector clicked: ${label} with ${value} threats`);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // Geographic Distribution Chart (Horizontal Bar)
            const geoDistributionCtx = document.getElementById('geoDistributionChart').getContext('2d');
            geoDistributionChart = new Chart(geoDistributionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Threats Detected',
                            data: [],
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: '#dc3545',
                            borderWidth: 1,
                            hoverBackgroundColor: 'rgba(220, 53, 69, 1.0)'
                        },
                        {
                            label: 'Threats Blocked',
                            data: [],
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1,
                            hoverBackgroundColor: 'rgba(40, 167, 69, 1.0)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Country: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data[context.dataIndex] || 0;
                                    const blocked = context.chart.data.datasets[1].data[context.dataIndex] || 0;
                                    const blockRate = total > 0 ? ((blocked / total) * 100).toFixed(1) : 0;
                                    
                                    if (context.datasetIndex === 0) {
                                        return `Threats Detected: ${context.parsed.x}`;
                                    } else {
                                        return `Threats Blocked: ${context.parsed.x} (${blockRate}% effectiveness)`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Threats'
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const country = this.data.labels[index];
                            const threats = this.data.datasets[0].data[index];
                            const blocked = this.data.datasets[1].data[index];
                            const rate = threats > 0 ? ((blocked / threats) * 100).toFixed(1) : 0;
                            console.log(`Geographic data clicked: ${country} - ${threats} threats, ${blocked} blocked (${rate}% rate)`);
                        }
                    }
                }
            });

            // Hourly Activity Chart (Area)
            const hourlyActivityCtx = document.getElementById('hourlyActivityChart').getContext('2d');
            hourlyActivityChart = new Chart(hourlyActivityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Threats Detected',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.3)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Threats Blocked',
                            data: [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.3)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Time: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const total = context.chart.data.datasets[0].data[context.dataIndex] || 0;
                                    const blocked = context.chart.data.datasets[1].data[context.dataIndex] || 0;
                                    const rate = total > 0 ? ((blocked / total) * 100).toFixed(1) : 0;
                                    
                                    if (context.datasetIndex === 0) {
                                        return `${context.dataset.label}: ${value}`;
                                    } else {
                                        return `${context.dataset.label}: ${value} (${rate}% of total)`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Threats'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24 Hour Format)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const time = this.data.labels[index];
                            const threats = this.data.datasets[0].data[index];
                            const blocked = this.data.datasets[1].data[index];
                            const rate = threats > 0 ? ((blocked / threats) * 100).toFixed(1) : 0;
                            console.log(`Hourly activity clicked: ${time} - ${threats} threats, ${blocked} blocked (${rate}% effectiveness)`);
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6,
                            borderWidth: 2
                        }
                    }
                }
            });
        }

        function loadInitialData() {
            loadCategories();
            loadSeverityData();
            loadAdvancedStats();
            
            // Initialize active charts with sample data
            setTimeout(() => {
                updateAttackVectorsChart();
                updateGeographicChart();
                updateHourlyActivityChart();
            }, 1000); // Wait for charts to be fully initialized
            
            // Start auto-refresh for dashboard stats
            startAutoRefresh();
        }

        function showOperationStatus(message, progress = 0) {
            const statusDiv = document.getElementById('operationStatus');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progress');
            
            statusMessage.textContent = message;
            progressBar.style.width = progress + '%';
            statusDiv.style.display = 'block';
            
            if (progress >= 100) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        function trainModels() {
            const trainBtn = document.getElementById('trainBtn');
            trainBtn.disabled = true;
            trainBtn.textContent = 'Training...';
            
            showOperationStatus('Starting model training...', 10);
            
            fetch('/api/dashboard/train', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                showOperationStatus('Training completed!', 100);
                
                if (data.status === 'success') {
                    trainBtn.className = 'success';
                    trainBtn.textContent = '‚úÖ Training Complete';
                    alert(`Training successful!\\nAccuracy: ${(data.metrics?.train_accuracy * 100 || 0).toFixed(1)}%`);
                } else {
                    trainBtn.className = 'danger';
                    trainBtn.textContent = '‚ùå Training Failed';
                    alert('Training failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Training error:', error);
                showOperationStatus('Training failed!', 100);
                trainBtn.className = 'danger';
                trainBtn.textContent = '‚ùå Training Failed';
            })
            .finally(() => {
                setTimeout(() => {
                    trainBtn.disabled = false;
                    trainBtn.className = '';
                    trainBtn.textContent = 'üöÄ Train Models';
                }, 3000);
            });
        }

        function toggleRealtime() {
            const realtimeBtn = document.getElementById('realtimeBtn');
            const endpoint = isRealtimeActive ? '/api/dashboard/realtime/stop' : '/api/dashboard/realtime/start';
            
            realtimeBtn.disabled = true;
            
            showOperationStatus(isRealtimeActive ? 'Stopping real-time detection...' : 'Starting real-time detection...', 50);
            
            fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                showOperationStatus(data.message, 100);
                
                if (data.status === 'success') {
                    isRealtimeActive = data.is_running;
                    updateRealtimeUI();
                } else {
                    alert(data.message || 'Operation failed');
                }
            })
            .catch(error => {
                console.error('Real-time operation error:', error);
                showOperationStatus('Operation failed!', 100);
            })
            .finally(() => {
                realtimeBtn.disabled = false;
            });
        }

        function updateRealtimeUI() {
            const realtimeBtn = document.getElementById('realtimeBtn');
            const headerStatus = document.getElementById('realtimeStatusHeader');
            
            if (isRealtimeActive) {
                realtimeBtn.textContent = '‚èπÔ∏è Stop Real-time';
                realtimeBtn.className = 'danger';
                headerStatus.textContent = 'Real-time: Active';
                headerStatus.className = 'realtime-status realtime-active';
            } else {
                realtimeBtn.textContent = '‚ñ∂Ô∏è Start Real-time';
                realtimeBtn.className = 'success';
                headerStatus.textContent = 'Real-time: Inactive';
                headerStatus.className = 'realtime-status realtime-inactive';
            }
        }

        function showAnalyzer() {
            const analyzerCard = document.getElementById('analyzerCard');
            analyzerCard.style.display = analyzerCard.style.display === 'none' ? 'block' : 'none';
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.textContent = analyzerCard.style.display === 'none' ? 'üîç Analyze Text' : '‚ùå Close Analyzer';
        }

        function showBulkAnalyzer() {
            const bulkCard = document.getElementById('bulkAnalyzer');
            bulkCard.style.display = bulkCard.style.display === 'none' ? 'block' : 'none';
            
            const bulkBtn = document.getElementById('bulkBtn');
            bulkBtn.textContent = bulkCard.style.display === 'none' ? 'üìä Bulk Analysis' : '‚ùå Close Bulk';
        }

        function analyzeText() {
            const text = document.getElementById('analyzeText').value;
            const submitBtn = document.getElementById('analyzeSubmitBtn');
            const resultDiv = document.getElementById('analysisResult');
            
            if (!text.trim()) {
                alert('Please enter text to analyze');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing...';
            
            fetch('/api/dashboard/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const analysis = data.analysis;
                    const topCategory = analysis.top_category;
                    const severity = analysis.severity;
                    
                    resultDiv.innerHTML = `
                        <h3>üìä Analysis Results</h3>
                        <p><strong>Top Category:</strong> ${topCategory[0]} (${(topCategory[1] * 100).toFixed(1)}% confidence)</p>
                        <p><strong>Severity:</strong> ${severity.severity} (${(severity.confidence * 100).toFixed(1)}% confidence)</p>
                        <p><strong>Categories Found:</strong></p>
                        <ul>${Object.entries(analysis.categories).map(([cat, score]) => 
                            `<li>${cat}: ${(score * 100).toFixed(1)}%</li>`).join('')}</ul>
                        <p><strong>Timestamp:</strong> ${analysis.timestamp}</p>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Refresh recent threats to show the new analysis
                    loadRecentThreats();
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">Analysis failed: ${data.message}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                resultDiv.innerHTML = '<p style="color: #dc3545;">Analysis failed due to network error</p>';
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze Threat Text';
            });
        }

        function updateRealtimeStats() {
            fetch('/api/dashboard/realtime/status')
                .then(response => response.json())
                .then(data => {
                    const statusSpan = document.getElementById('realtimeStatus');
                    const processedSpan = document.getElementById('threatsProcessed');
                    const rateSpan = document.getElementById('realtimeDetectionRate');
                    
                    statusSpan.textContent = data.is_running ? 'Active' : 'Inactive';
                    statusSpan.style.color = data.is_running ? '#28a745' : '#dc3545';
                    
                    const stats = data.statistics || {};
                    processedSpan.textContent = stats.total_processed || 0;
                    rateSpan.textContent = ((stats.detection_rate || 0) * 100).toFixed(1) + '%';
                    
                    isRealtimeActive = data.is_running;
                    updateRealtimeUI();
                })
                .catch(error => {
                    console.error('Error loading real-time stats:', error);
                });
        }

        function loadDashboardStats() {
            fetch('/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalThreats').textContent = data.total_threats || 0;
                    document.getElementById('highSeverity').textContent = data.critical_threats || 0;
                    document.getElementById('detectionRate').textContent = (data.detection_rate || 0) + '%';
                    document.getElementById('systemStatus').textContent = 'Active';
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    document.getElementById('totalThreats').textContent = 'Error';
                });
        }

        function loadRecentThreats() {
            fetch('/api/dashboard/threats/recent?limit=5')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentThreats');
                    
                    if (data.threats && data.threats.length > 0) {
                        container.innerHTML = data.threats.map(threat => {
                            const severityClass = threat.severity ? `threat-${threat.severity.toLowerCase()}` : 'threat-low';
                            return `
                                <div class="threat-item ${severityClass}">
                                    <strong>${threat.category || 'Unknown'}</strong><br>
                                    ${threat.description || 'No description available'}<br>
                                    <small>Severity: ${threat.severity || 'Unknown'} | ${threat.timestamp || ''}</small>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="threat-item">No recent threats detected.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading threats:', error);
                    document.getElementById('recentThreats').innerHTML = 
                        '<div class="threat-item">Error loading threat data.</div>';
                });
        }

        function loadCategories() {
            fetch('/api/dashboard/threats/categories')
                .then(response => response.json())
                .then(data => {
                    if (data.categories && Object.keys(data.categories).length > 0) {
                        const categories = Object.keys(data.categories);
                        const counts = Object.values(data.categories);
                        
                        categoriesChart.data.labels = categories;
                        categoriesChart.data.datasets[0].data = counts;
                        categoriesChart.update('active');
                    } else {
                        // Show sample data if no real data available
                        categoriesChart.data.labels = ['Malware', 'Phishing', 'DDoS', 'Ransomware', 'APT'];
                        categoriesChart.data.datasets[0].data = [25, 18, 12, 8, 15];
                        categoriesChart.update('active');
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    // Show sample data on error
                    categoriesChart.data.labels = ['Malware', 'Phishing', 'DDoS', 'Ransomware', 'APT'];
                    categoriesChart.data.datasets[0].data = [25, 18, 12, 8, 15];
                    categoriesChart.update('active');
                });
        }

        function loadSeverityData() {
            fetch('/api/dashboard/threats/severity/realtime')
                .then(response => response.json())
                .then(data => {
                    const realtimeData = data.realtime_severity;
                    
                    if (realtimeData) {
                        // Update severity distribution chart
                        const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];
                        const severityData = severityOrder.map(level => 
                            realtimeData.current_distribution[level] || 0
                        );
                        
                        severityChart.data.datasets[0].data = severityData;
                        severityChart.update('active');
                        
                        // Update time series chart
                        if (realtimeData.time_series && realtimeData.time_series.length > 0) {
                            const timeLabels = realtimeData.time_series.map(item => item.timestamp);
                            const criticalData = realtimeData.time_series.map(item => item.critical);
                            const highData = realtimeData.time_series.map(item => item.high);
                            const mediumData = realtimeData.time_series.map(item => item.medium);
                            
                            severityTimeSeriesChart.data.labels = timeLabels;
                            severityTimeSeriesChart.data.datasets[0].data = criticalData;
                            severityTimeSeriesChart.data.datasets[1].data = highData;
                            severityTimeSeriesChart.data.datasets[2].data = mediumData;
                            severityTimeSeriesChart.update('active');
                        }
                        
                        // Update metrics
                        if (realtimeData.trends) {
                            document.getElementById('criticalRate').textContent = realtimeData.trends.critical_rate + '%';
                            document.getElementById('threatVelocity').textContent = realtimeData.trends.threat_velocity + '/min';
                            document.getElementById('detectionAccuracy').textContent = realtimeData.trends.detection_accuracy + '%';
                        }
                        
                        if (realtimeData.alerts) {
                            document.getElementById('activeIncidents').textContent = realtimeData.alerts.active_incidents;
                            document.getElementById('blockedAttacks').textContent = realtimeData.alerts.blocked_attacks;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading severity data:', error);
                    // Show sample data
                    severityChart.data.datasets[0].data = [12, 25, 35, 45, 78];
                    severityChart.update('active');
                });
        }

        function loadAdvancedStats() {
            fetch('/api/dashboard/stats/advanced')
                .then(response => response.json())
                .then(data => {
                    const advancedStats = data.advanced_stats;
                    
                    if (advancedStats) {
                        // Update attack vectors chart
                        if (advancedStats.attack_vectors) {
                            const vectorLabels = advancedStats.attack_vectors.map(v => v.vector);
                            const vectorCounts = advancedStats.attack_vectors.map(v => v.count);
                            
                            attackVectorsChart.data.labels = vectorLabels;
                            attackVectorsChart.data.datasets[0].data = vectorCounts;
                            attackVectorsChart.update('active');
                        }
                        
                        // Update geographic distribution
                        if (advancedStats.geographic_distribution) {
                            const geoLabels = advancedStats.geographic_distribution.map(g => g.country);
                            const threatCounts = advancedStats.geographic_distribution.map(g => g.threats);
                            const blockedCounts = advancedStats.geographic_distribution.map(g => g.blocked);
                            
                            geoDistributionChart.data.labels = geoLabels;
                            geoDistributionChart.data.datasets[0].data = threatCounts;
                            geoDistributionChart.data.datasets[1].data = blockedCounts;
                            geoDistributionChart.update('active');
                        }
                        
                        // Update hourly activity
                        if (advancedStats.hourly_patterns) {
                            const hourLabels = advancedStats.hourly_patterns.map(h => h.hour);
                            const threatsByHour = advancedStats.hourly_patterns.map(h => h.threats);
                            const blockedByHour = advancedStats.hourly_patterns.map(h => h.blocked);
                            
                            hourlyActivityChart.data.labels = hourLabels;
                            hourlyActivityChart.data.datasets[0].data = threatsByHour;
                            hourlyActivityChart.data.datasets[1].data = blockedByHour;
                            hourlyActivityChart.update('active');
                        }
                        
                        // Update system metrics
                        if (advancedStats.system_performance) {
                            const sysPerf = advancedStats.system_performance;
                            document.getElementById('systemCPU').textContent = sysPerf.cpu_usage + '%';
                            document.getElementById('memoryUsage').textContent = sysPerf.memory_usage + '%';
                            document.getElementById('networkThroughput').textContent = sysPerf.network_throughput + ' MB/s';
                            document.getElementById('activeConnections').textContent = sysPerf.active_connections;
                            
                            // Update progress bars
                            document.getElementById('memoryProgress').style.width = sysPerf.memory_usage + '%';
                        }
                        
                        // Update threat intelligence metrics
                        if (advancedStats.threat_intelligence) {
                            const threatIntel = advancedStats.threat_intelligence;
                            document.getElementById('iocFeeds').textContent = threatIntel.ioc_feeds;
                            document.getElementById('feedHealth').textContent = threatIntel.feed_health + '%';
                            document.getElementById('dataFreshness').textContent = threatIntel.data_freshness + ' min';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading advanced stats:', error);
                });
        }

        function toggleSeverityRealtime() {
            const button = document.getElementById('severityRealtimeBtn');
            
            if (!isSeverityRealtimeActive) {
                // Start real-time updates
                isSeverityRealtimeActive = true;
                button.textContent = 'Stop Real-time';
                button.style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
                
                severityRealtimeInterval = setInterval(() => {
                    loadSeverityData();
                }, 5000); // Update every 5 seconds
            } else {
                // Stop real-time updates
                isSeverityRealtimeActive = false;
                button.textContent = 'Start Real-time';
                button.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                
                if (severityRealtimeInterval) {
                    clearInterval(severityRealtimeInterval);
                }
            }
        }

        function toggleAdvancedRealtime() {
            const button = document.getElementById('advancedRealtimeBtn');
            
            if (!isAdvancedRealtimeActive) {
                // Start real-time monitoring
                isAdvancedRealtimeActive = true;
                button.textContent = 'Stop Monitoring';
                button.style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
                
                advancedRealtimeInterval = setInterval(() => {
                    loadAdvancedStats();
                }, 10000); // Update every 10 seconds
            } else {
                // Stop real-time monitoring
                isAdvancedRealtimeActive = false;
                button.textContent = 'Start Monitoring';
                button.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                
                if (advancedRealtimeInterval) {
                    clearInterval(advancedRealtimeInterval);
                }
            }
        }

        function resetSeverityChart() {
            severityChart.data.datasets[0].data = [0, 0, 0, 0, 0];
            severityChart.update('active');
            
            severityTimeSeriesChart.data.labels = [];
            severityTimeSeriesChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            severityTimeSeriesChart.update('active');
        }

        function refreshAdvancedStats() {
            loadAdvancedStats();
        }

        function exportChart(chartType) {
            let chart;
            let filename;
            
            switch(chartType) {
                case 'categories':
                    chart = categoriesChart;
                    filename = 'threat_categories_chart.png';
                    break;
                case 'severity':
                    chart = severityChart;
                    filename = 'severity_distribution_chart.png';
                    break;
                case 'realtime':
                    chart = hourlyActivityChart;
                    filename = 'realtime_statistics_chart.png';
                    break;
                case 'attack_vectors':
                    chart = attackVectorsChart;
                    filename = 'attack_vectors_chart.png';
                    break;
                case 'geographic':
                    chart = geoDistributionChart;
                    filename = 'geographic_distribution_chart.png';
                    break;
                case 'hourly':
                    chart = hourlyActivityChart;
                    filename = 'hourly_activity_chart.png';
                    break;
                default:
                    return;
            }
            
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                link.click();
            }
        }

        // Enhanced Active Chart Functions
        function startAttackVectorsLiveMode() {
            if (!window.attackVectorsInterval) {
                window.attackVectorsInterval = setInterval(() => {
                    updateAttackVectorsChart();
                }, 8000); // Update every 8 seconds
                
                document.getElementById('attackVectorsLiveBtn').textContent = 'Stop Live Mode';
                document.getElementById('attackVectorsLiveBtn').style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
                console.log('Attack Vectors live mode started');
            } else {
                clearInterval(window.attackVectorsInterval);
                window.attackVectorsInterval = null;
                document.getElementById('attackVectorsLiveBtn').textContent = 'Start Live Mode';
                document.getElementById('attackVectorsLiveBtn').style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                console.log('Attack Vectors live mode stopped');
            }
        }

        function updateAttackVectorsChart() {
            // Generate dynamic attack vector data
            const attackTypes = ['Malware', 'Phishing', 'DDoS', 'SQL Injection', 'XSS', 'Brute Force', 'Ransomware', 'APT'];
            const newData = attackTypes.map(() => Math.floor(Math.random() * 150) + 50);
            
            // Animate data changes
            attackVectorsChart.data.labels = attackTypes;
            attackVectorsChart.data.datasets[0].data = newData;
            attackVectorsChart.data.datasets[0].backgroundColor = newData.map(value => {
                if (value > 120) return '#dc3545';  // Critical
                if (value > 90) return '#fd7e14';   // High
                if (value > 60) return '#ffc107';   // Medium
                return '#28a745';                   // Low
            });
            
            attackVectorsChart.update('active');
            
            // Update metrics display
            const totalThreats = newData.reduce((a, b) => a + b, 0);
            const highestThreat = Math.max(...newData);
            const avgThreat = Math.round(totalThreats / newData.length);
            
            console.log(`Attack Vectors Updated: Total=${totalThreats}, Highest=${highestThreat}, Avg=${avgThreat}`);
        }

        function startGeographicLiveMode() {
            if (!window.geographicInterval) {
                window.geographicInterval = setInterval(() => {
                    updateGeographicChart();
                }, 12000); // Update every 12 seconds
                
                document.getElementById('geographicLiveBtn').textContent = 'Stop Live Mode';
                document.getElementById('geographicLiveBtn').style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
                console.log('Geographic Distribution live mode started');
            } else {
                clearInterval(window.geographicInterval);
                window.geographicInterval = null;
                document.getElementById('geographicLiveBtn').textContent = 'Start Live Mode';
                document.getElementById('geographicLiveBtn').style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                console.log('Geographic Distribution live mode stopped');
            }
        }

        function updateGeographicChart() {
            const countries = ['United States', 'China', 'Russia', 'Brazil', 'India', 'Germany', 'United Kingdom', 'France'];
            const threatsData = countries.map(() => Math.floor(Math.random() * 200) + 50);
            const blockedData = threatsData.map(threats => Math.floor(threats * (Math.random() * 0.4 + 0.6))); // 60-100% blocked
            
            geoDistributionChart.data.labels = countries;
            geoDistributionChart.data.datasets[0].data = threatsData;
            geoDistributionChart.data.datasets[1].data = blockedData;
            geoDistributionChart.update('active');
            
            // Calculate and display blocking efficiency
            const totalThreats = threatsData.reduce((a, b) => a + b, 0);
            const totalBlocked = blockedData.reduce((a, b) => a + b, 0);
            const blockingRate = ((totalBlocked / totalThreats) * 100).toFixed(1);
            
            console.log(`Geographic Updated: ${totalThreats} threats, ${totalBlocked} blocked (${blockingRate}% efficiency)`);
        }

        function startHourlyActivityLiveMode() {
            if (!window.hourlyActivityInterval) {
                window.hourlyActivityInterval = setInterval(() => {
                    updateHourlyActivityChart();
                }, 15000); // Update every 15 seconds
                
                document.getElementById('hourlyActivityLiveBtn').textContent = 'Stop Live Mode';
                document.getElementById('hourlyActivityLiveBtn').style.background = 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)';
                console.log('Hourly Activity live mode started');
            } else {
                clearInterval(window.hourlyActivityInterval);
                window.hourlyActivityInterval = null;
                document.getElementById('hourlyActivityLiveBtn').textContent = 'Start Live Mode';
                document.getElementById('hourlyActivityLiveBtn').style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                console.log('Hourly Activity live mode stopped');
            }
        }

        function updateHourlyActivityChart() {
            const currentHour = new Date().getHours();
            const hours = [];
            const threatsData = [];
            const blockedData = [];
            
            // Generate 24 hours of data with realistic patterns
            for (let i = 0; i < 24; i++) {
                const hour = (currentHour - 23 + i + 24) % 24;
                hours.push(`${hour.toString().padStart(2, '0')}:00`);
                
                // Business hours have more activity
                let baseActivity = 50;
                if (hour >= 9 && hour <= 17) {
                    baseActivity = 150;  // Business hours
                } else if (hour >= 18 && hour <= 22) {
                    baseActivity = 100;  // Evening
                } else {
                    baseActivity = 30;   // Night/early morning
                }
                
                // Add some randomness
                const threats = Math.floor(baseActivity * (Math.random() * 0.6 + 0.7));
                const blocked = Math.floor(threats * (Math.random() * 0.3 + 0.7)); // 70-100% blocked
                
                threatsData.push(threats);
                blockedData.push(blocked);
            }
            
            hourlyActivityChart.data.labels = hours;
            hourlyActivityChart.data.datasets[0].data = threatsData;
            hourlyActivityChart.data.datasets[1].data = blockedData;
            hourlyActivityChart.update('active');
            
            const currentThreats = threatsData[23]; // Latest hour
            const currentBlocked = blockedData[23];
            const currentRate = ((currentBlocked / currentThreats) * 100).toFixed(1);
            
            console.log(`Hourly Activity Updated: Current hour ${currentThreats} threats, ${currentBlocked} blocked (${currentRate}%)`);
        }

        // Enhanced chart interaction functions
        function resetAllCharts() {
            // Reset all charts to initial state
            const charts = [categoriesChart, severityChart, severityTimeSeriesChart, attackVectorsChart, geoDistributionChart, hourlyActivityChart];
            
            charts.forEach(chart => {
                if (chart) {
                    chart.data.datasets.forEach(dataset => {
                        dataset.data = [];
                    });
                    chart.data.labels = [];
                    chart.update('none'); // No animation for reset
                }
            });
            
            console.log('All charts reset');
        }

        function pauseAllLiveModes() {
            // Stop all live chart updates
            const intervals = [
                'attackVectorsInterval',
                'geographicInterval', 
                'hourlyActivityInterval',
                'severityRealtimeInterval',
                'advancedRealtimeInterval'
            ];
            
            intervals.forEach(intervalName => {
                if (window[intervalName]) {
                    clearInterval(window[intervalName]);
                    window[intervalName] = null;
                }
            });
            
            // Reset button states
            const buttons = [
                'attackVectorsLiveBtn',
                'geographicLiveBtn',
                'hourlyActivityLiveBtn',
                'severityRealtimeBtn',
                'advancedRealtimeBtn'
            ];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.textContent = btn.textContent.replace('Stop', 'Start');
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                }
            });
            
            console.log('All live modes paused');
        }

        function startAllLiveModes() {
            // Start all chart live modes
            if (document.getElementById('attackVectorsLiveBtn')) startAttackVectorsLiveMode();
            if (document.getElementById('geographicLiveBtn')) startGeographicLiveMode();
            if (document.getElementById('hourlyActivityLiveBtn')) startHourlyActivityLiveMode();
            toggleSeverityRealtime();
            toggleAdvancedRealtime();
            
            console.log('All live modes started');
        }

        // Chart drill-down functionality
        function onChartClick(chart, event) {
            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            
            if (points.length) {
                const firstPoint = points[0];
                const label = chart.data.labels[firstPoint.index];
                const value = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
                
                console.log(`Chart clicked: ${label} = ${value}`);
                
                // Show detailed information modal (could be enhanced further)
                alert(`Detailed Info:\nCategory: ${label}\nValue: ${value}\nClick timestamp: ${new Date().toLocaleTimeString()}`);
            }
        }

        // Enhanced chart tooltips
        function createAdvancedTooltips() {
            Chart.defaults.plugins.tooltip.callbacks.title = function(tooltipItems) {
                return tooltipItems[0].label + ' - Live Data';
            };
            
            Chart.defaults.plugins.tooltip.callbacks.label = function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.y || context.parsed;
                const percentage = context.dataset.data.length > 0 ? 
                    ((value / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1) : 0;
                
                return `${label}: ${value} (${percentage}%)`;
            };
        }

        function submitThreat() {
            // This would integrate with the existing threat submission system
            const threatText = document.getElementById('threatText').value;
            if (!threatText.trim()) {
                alert('Please enter a threat description');
                return;
            }
            
            // For now, just analyze the text as a threat
            document.getElementById('analyzeText').value = threatText;
            showAnalyzer();
            analyzeText();
            
            document.getElementById('threatText').value = '';
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadDashboardStats();
                loadRecentThreats();
                updateRealtimeStats();
            }, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Threat Intelligence Sharing Functions
        function showIntelligenceStatus(message, progress = 0) {
            const statusDiv = document.getElementById('intelligenceStatus');
            const messageDiv = document.getElementById('intelligenceMessage');
            const progressBar = document.getElementById('intelligenceProgress');
            
            messageDiv.textContent = message;
            progressBar.style.width = progress + '%';
            statusDiv.style.display = 'block';
            
            if (progress >= 100) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        function uploadIntelligence() {
            const fileInput = document.getElementById('fileUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files.length) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            showIntelligenceStatus('Uploading file...', 25);
            
            fetch('/api/dashboard/intelligence/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showIntelligenceStatus('Upload completed!', 100);
                
                if (data.status === 'success') {
                    alert(`Upload successful! Processed ${data.threats_processed} threats.`);
                    loadRecentThreats();
                    loadDashboardStats();
                } else {
                    alert('Upload failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showIntelligenceStatus('Upload failed!', 100);
                alert('Upload failed due to network error');
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
                fileInput.value = '';
            });
        }

        function showImportDialog() {
            const importDialog = document.getElementById('importDialog');
            importDialog.style.display = importDialog.style.display === 'none' ? 'block' : 'none';
        }

        function hideImportDialog() {
            document.getElementById('importDialog').style.display = 'none';
            document.getElementById('importData').value = '';
            document.getElementById('importResult').style.display = 'none';
        }

        function importIntelligence() {
            const source = document.getElementById('importSourceSelect').value;
            const dataText = document.getElementById('importData').value.trim();
            const submitBtn = document.getElementById('importSubmitBtn');
            const resultDiv = document.getElementById('importResult');
            
            if (!dataText) {
                alert('Please enter data to import');
                return;
            }
            
            let importData;
            try {
                if (source !== 'manual') {
                    importData = JSON.parse(dataText);
                } else {
                    // Manual entry - each line is a threat
                    const lines = dataText.split('\n').filter(line => line.trim());
                    importData = {
                        threats: lines.map(line => ({
                            description: line.trim(),
                            category: 'manual',
                            severity: 'MEDIUM'
                        }))
                    };
                }
            } catch (e) {
                alert('Invalid data format. Please check your input.');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Importing...';
            showIntelligenceStatus('Importing threat intelligence...', 50);
            
            fetch('/api/dashboard/intelligence/import', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({source: source, ...importData})
            })
            .then(response => response.json())
            .then(data => {
                showIntelligenceStatus('Import completed!', 100);
                
                if (data.status === 'success') {
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Import Successful</h3>
                        <p>Imported ${data.threats_imported} threats from ${data.source}</p>
                        <p>Timestamp: ${data.timestamp}</p>
                    `;
                    resultDiv.style.display = 'block';
                    loadRecentThreats();
                    loadDashboardStats();
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">Import failed: ${data.message}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Import error:', error);
                showIntelligenceStatus('Import failed!', 100);
                resultDiv.innerHTML = '<p style="color: #dc3545;">Import failed due to network error</p>';
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Import Data';
            });
        }

        function exportIntelligence() {
            const format = document.getElementById('exportFormat').value;
            const exportBtn = document.getElementById('exportBtn');
            
            exportBtn.disabled = true;
            exportBtn.textContent = 'Exporting...';
            showIntelligenceStatus('Exporting threat intelligence...', 75);
            
            // Create download link
            const url = `/api/dashboard/intelligence/export?format=${format}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `threat_intelligence.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showIntelligenceStatus('Export completed!', 100);
            exportBtn.disabled = false;
            exportBtn.textContent = 'Export Data';
        }

        function extractEntities() {
            const text = document.getElementById('analyzeText').value;
            const entitiesBtn = document.getElementById('entitiesBtn');
            const resultDiv = document.getElementById('entitiesResult');
            
            if (!text.trim()) {
                alert('Please enter text to extract entities from');
                return;
            }
            
            entitiesBtn.disabled = true;
            entitiesBtn.textContent = 'Extracting...';
            
            fetch('/api/dashboard/semantic/entities', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const entities = data.entities;
                    const stats = data.statistics;
                    
                    let entitiesHtml = '<h3>üîç Extracted Entities</h3>';
                    entitiesHtml += `<p><strong>Total entities found:</strong> ${stats.total_entities}</p>`;
                    
                    for (const [type, values] of Object.entries(entities)) {
                        if (values.length > 0) {
                            entitiesHtml += `<p><strong>${type.replace('_', ' ').toUpperCase()}:</strong> ${values.join(', ')}</p>`;
                        }
                    }
                    
                    resultDiv.innerHTML = entitiesHtml;
                    resultDiv.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">Entity extraction failed: ${data.message}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Entity extraction error:', error);
                resultDiv.innerHTML = '<p style="color: #dc3545;">Entity extraction failed due to network error</p>';
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                entitiesBtn.disabled = false;
                entitiesBtn.textContent = 'Extract Entities';
            });
        }

        function analyzeBulk() {
            const bulkText = document.getElementById('bulkAnalyzeText').value;
            const bulkBtn = document.getElementById('bulkAnalyzeBtn');
            const resultDiv = document.getElementById('bulkAnalysisResult');
            
            if (!bulkText.trim()) {
                alert('Please enter texts to analyze (one per line)');
                return;
            }
            
            const texts = bulkText.split('\n').filter(line => line.trim()).map(line => line.trim());
            
            bulkBtn.disabled = true;
            bulkBtn.textContent = 'Analyzing...';
            showIntelligenceStatus('Performing bulk analysis...', 60);
            
            fetch('/api/dashboard/semantic/analyze-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({texts: texts})
            })
            .then(response => response.json())
            .then(data => {
                showIntelligenceStatus('Bulk analysis completed!', 100);
                
                if (data.status === 'success') {
                    let analysisHtml = '<h3>üìä Bulk Analysis Results</h3>';
                    analysisHtml += `<div style="margin-bottom: 15px;">`;
                    analysisHtml += `<strong>Total analyzed:</strong> ${data.total_analyzed}<br>`;
                    analysisHtml += `<strong>Successful analyses:</strong> ${data.successful_analyses}<br>`;
                    analysisHtml += `<strong>Threats detected:</strong> ${data.threats_detected}<br>`;
                    analysisHtml += `</div>`;
                    
                    analysisHtml += '<h4>Category Distribution:</h4>';
                    for (const [category, count] of Object.entries(data.categories_distribution)) {
                        analysisHtml += `<div>${category}: ${count}</div>`;
                    }
                    
                    analysisHtml += '<h4>Severity Distribution:</h4>';
                    for (const [severity, count] of Object.entries(data.severities_distribution)) {
                        analysisHtml += `<div>${severity}: ${count}</div>`;
                    }
                    
                    resultDiv.innerHTML = analysisHtml;
                    resultDiv.style.display = 'block';
                    
                    loadRecentThreats(); // Refresh to show new analyzed threats
                    loadDashboardStats();
                } else {
                    resultDiv.innerHTML = `<p style="color: #dc3545;">Bulk analysis failed: ${data.message}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Bulk analysis error:', error);
                showIntelligenceStatus('Bulk analysis failed!', 100);
                resultDiv.innerHTML = '<p style="color: #dc3545;">Bulk analysis failed due to network error</p>';
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                bulkBtn.disabled = false;
                bulkBtn.textContent = 'Analyze All Texts';
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadRecentThreats();
            loadCategories();
            updateRealtimeStats();
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>